# Railway Deployment Guide for CookGas

## Prerequisites
- Railway account (sign up at https://railway.app with GitHub)
- GitHub repository already set up ✅

## Deployment Steps

### 1. Create New Project on Railway
1. Go to https://railway.app/new
2. Click "Deploy from GitHub repo"
3. Select `cypher6783/gasOrder`
4. Railway will create a new project

### 2. Deploy Backend API

#### A. Add PostgreSQL Database
1. In your Railway project, click "New"
2. Select "Database" → "PostgreSQL"
3. Railway auto-generates `DATABASE_URL`
4. **Enable PostGIS extension:**
   - Click on the PostgreSQL service
   - Go to "Connect" tab
   - Copy the connection string
   - Use a PostgreSQL client or Railway's built-in terminal:
     ```sql
     CREATE EXTENSION IF NOT EXISTS postgis;
     ```

#### B. Deploy Backend Service
1. Click "New" → "GitHub Repo"
2. Select your repository
3. Railway will detect it's a monorepo
4. Click "Add variables" and set:
   ```
   ROOT=/apps/api
   ```

#### C. Add Environment Variables
Click on the backend service → "Variables" tab:

```bash
# Database (auto-generated by Railway)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# JWT
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
JWT_EXPIRES_IN=7d
JWT_REFRESH_EXPIRES_IN=30d

# Server
PORT=4000
NODE_ENV=production

# CORS (will update after frontend deployment)
ALLOWED_ORIGINS=https://your-frontend-url.up.railway.app

# Paystack
PAYSTACK_SECRET_KEY=sk_test_your_key_here
PAYSTACK_PUBLIC_KEY=pk_test_your_key_here

# Frontend URL (will update after frontend deployment)
FRONTEND_URL=https://your-frontend-url.up.railway.app
```

#### D. Deploy
1. Railway will automatically deploy
2. Wait for deployment to complete
3. Copy the generated URL (e.g., `https://your-api.up.railway.app`)

### 3. Deploy Frontend

#### A. Add Frontend Service
1. In the same project, click "New" → "GitHub Repo"
2. Select your repository again
3. Set root directory:
   ```
   ROOT=/apps/web
   ```

#### B. Add Environment Variables
```bash
NEXT_PUBLIC_API_URL=https://your-backend-url.up.railway.app
```

#### C. Deploy
1. Railway will automatically build and deploy
2. Copy the generated frontend URL

### 4. Update Backend CORS Settings

Go back to backend service → Variables:
1. Update `ALLOWED_ORIGINS` with your frontend URL
2. Update `FRONTEND_URL` with your frontend URL
3. Redeploy backend service

### 5. Configure Custom Domains (Optional)

#### Backend:
1. Click backend service → "Settings" → "Domains"
2. Click "Generate Domain" or add custom domain
3. Example: `api.cookgas.com`

#### Frontend:
1. Click frontend service → "Settings" → "Domains"
2. Click "Generate Domain" or add custom domain
3. Example: `cookgas.com`

## Post-Deployment Checklist

- [ ] Backend API is accessible
- [ ] Frontend loads correctly
- [ ] Database migrations ran successfully
- [ ] Can register/login users
- [ ] Can create orders
- [ ] Payment integration works (test with Paystack test keys)
- [ ] Update Paystack webhook URL to: `https://your-api-url/api/payments/webhook`

## Monitoring

### View Logs
- Click on each service
- Go to "Deployments" tab
- Click on latest deployment
- View build and runtime logs

### Database Access
- Click on PostgreSQL service
- Use "Connect" tab for connection details
- Use Railway's built-in database browser or external tools

## Troubleshooting

### Build Failures
- Check build logs in Railway
- Verify `package.json` scripts exist
- Ensure all dependencies are in `package.json`

### Runtime Errors
- Check deployment logs
- Verify environment variables are set correctly
- Check database connection

### Database Issues
- Verify PostGIS extension is enabled
- Check migration status: Railway terminal → `npx prisma migrate status`
- Reset if needed: `npx prisma migrate reset` (⚠️ deletes all data)

## Environment Variables Reference

### Backend Required Variables
- `DATABASE_URL` - Auto-generated by Railway
- `JWT_SECRET` - Generate a strong random string
- `PAYSTACK_SECRET_KEY` - From Paystack dashboard
- `PAYSTACK_PUBLIC_KEY` - From Paystack dashboard
- `FRONTEND_URL` - Your frontend Railway URL
- `ALLOWED_ORIGINS` - Your frontend Railway URL

### Frontend Required Variables
- `NEXT_PUBLIC_API_URL` - Your backend Railway URL

## Useful Commands

### Run migrations manually:
```bash
npx prisma migrate deploy
```

### Seed database:
```bash
npx prisma db seed
```

### View database:
```bash
npx prisma studio
```

## Support
- Railway Docs: https://docs.railway.app
- Railway Discord: https://discord.gg/railway
